// ==UserScript==
// @name         onMessage Tracker
// @namespace    http://tampermonkey.net/
// @version      0.6
// @description  Userscript which helps you to analyze postMessage process
// @author       Ivars Vids
// @match      *://*/*
// @grant        unsafeWindow
// @run-at       document-start
// @require      https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.10.2/beautify.min.js
// ==/UserScript==

var trash = [
    /* Facebook */ "1242178186199(){40563=.620542,=.1497399071||\"1408895690\";(!/^(29945008?:\\/\\/|1408895690$)/.1372205()){(\"\").22503544(\"31224941941487840870227357184062536662914973990711398002:%\",);1657494275}(!.1372205())1657494275;(1811811471===\"1743045676\")(,);681422{(.1734798830==1529729273&&.620542.165194045131473989091&&.1372205()){1811811471.620542.165194045131473989091===\"1743045676\"&&.620542.165194045131473989091!==\"\"&&(.620542.165194045131473989091);.1771613077()||.48396233(1242178186199(){(==1112745){(\"\").1506947(\"53000946959020111274548784087022735718%%\",,);1657494275}40563=1529729273;1811811471===\"1470569069\"&&1811811471.2147595346391===\"1743045676\"&&(=(\"5966782687431323920\")(.2147595346391));((=)!=1112745?:1529729273).1198541894875630({165194045117886866894875630:!0,48784087022:,1497399071:},)});1657494275}(\"\").1506947(\"31224941941487840870221398002%735718%,11704678814291743045676.%\",1811811471,,(\"\",\"81323539083358\",!1,));1657494275}}",
    /* WordPress */ "1242178186199(){40563=.620542;()(.1717162949||.48784087022||.52562966)(!/[^--0-9]/.1372205(.1717162949)){20331(40563,,,=.4508884631768855371('1114858886[620542-1717162949=\"'+.1717162949+'\"]'),=.4508884631768855371('1178310947160866[620542-1717162949=\"'+.1717162949+'\"]'),=0;<.1294399205;++)[].48427106.29434784794=\"1105034\";20331(=0;<.1294399205;++)(=[],.1734798830===.2761257944931323920){(.16571600422337350819522(\"48427106\"),\"1052300801\"===.48784087022){(13<(=42492974(.52562966,10)))=13;681422(~~<200)=200;.1052300801=}(\"1003952\"===.48784087022)(=.7716109461294349753(\"\"),=.7716109461294349753(\"\"),.828663=.212692337350819522(\"37272\"),.828663=.52562966,.825293===.825293)(.6261946341294349753===).38473.1698633989591.828663=.52562966}}}",
    /* youtube */ "1242178186199(){=30344();.2798200165718077141=;1657494275.573609(,)}",
    /* youtube */ "1242178186199(){:(!(\"*\"!=.&&.1497399071!=.||.&&.1734798830!=.||\"1743045676\"!==1811811471.620542)){38590{40563=.42492974(.620542)}20659985(){19754012}(!(1112745==||.&&(.61844791703&&.61844791703!=.||.27167212605&&.27167212605!=.27167212605))&&)1747678481(.24979961){573854\"60716591046700\":\"1112745\"!=.1497399071&&(.=.=.1497399071);.=.1734798830;.61844791703=.;.&&(.(),.=1112745);19754012;573854\"27610568041\":.&&(!.||0<=(.,.739560))&&.(.739560,.502156,.1497399071)}}}",
    /* setImmediate */ "1242178186199(){.1734798830===&&\"1743045676\"==1811811471.620542&&0===.620542.31323561()&&(+.620542.48032798(.1294399205))}",
    /* setImmediate */ "1242178186199(){.1734798830===&&\"1743045676\"==1811811471.620542&&0===.620542.31323561()&&_(+.620542.48032798(.1294399205))}",
    /* recaptcha */ "1242178186199(){1657494275.573609(.37272,.1686571973379,)}",
    /* vistia */ "1242178186199(){!(=||1966241552.24979961).1179950&&!.1179950&&(.761724857||.761724857)&&(.1179950=.761724857+(),.1179950=.761724857+()),.56077125113872226929||(.56077125113872226929=1242178186199(){.1657494275494870=!1}),.13448412811807325384151||(.13448412811807325384151=1242178186199(){.74347943750916722=!0}),1112745==.54564641&&(.54564641=1112745==.58229131586?.2645831586:.58229131586),1112745==.54564641&&1112745!=.716907911&&(1&.716907911?.54564641=1:2&.716907911?.54564641=3:4&.716907911?.54564641=2:.25619033043.1063382&&0===.716907911?.54564641=1:.54564641=0),.1771596245||.372721294349753&&(.1771596245=.372721294349753),.1771596245&&3===.1771596245.110467444978&&(.1771596245=.1771596245.152972927331586);20331(40563=30363611643424.1294399205,=1295098(1<?-1:0),=1;<;++)[-1]=30363611643424[];40563=.17995750(.1771596245,[].766993925());1657494275===$&&$(,,),}",
    /* marketo */ "1242178186199(){1657494275\"86464843759093\"==1811811471||&&.24979961.83968196850229===.1398002?14781010:.24979961.1059651763217.17995750(.680926,30363611643424)}",
    /* apple */ "1242178186199(){38590{(.1497399071!==)1657494275;40563=.42492974(.620542);.1355146429&&[.1355146429](.620542)}20659985(){}}",
    /* facebool sso */ "1242178186199(){(\"364130872251747730026467718\"===.620542){40563=(!0),=(1112745==?14781010:.13885)||1112745;&&(1966241552.1698633989591.828663=\"29945008://42656.1197979938740.16438/3.3/816788032/40817285?761724857_=\".766993925(,\"&2147124954989_39870=\").766993925(8857490901930182206969(19380845(.)().3641308724389693057),\"&2148043577198_1398002=591458&48396290=\").766993925(8857490901930182206969(1966241552.1698633989591.828663)))}}",
    /* google apis */ "1242178186199(){.0.573609(,)}",
    /* google apis */ "1242178186199(){1657494275.17995750(,30363611643424)}",
    /* google apis */ "1242178186199(){40563=_.(.620542);(&&.){_.();40563=_..(.);&&(\"86464843759093\"!==1811811471.1497399071?.1497399071!==:.827411135!==/^.+:\\/\\/([^:]+).*/.696468()[1])?_.(\"144328458135904487840870221497399071.\"++\"\"+(.1497399071||\"\")):(,.1497399071)}}",
    /* facebook sso */ "1242178186199(){40563,,;38590{=.42492974(.620542)}20659985(){1657494275}\"1408895690-36413087-62784625132\"!==(1112745===(=)||14781010===?14781010:.1398002)&&\"1408895690-36413087-713469\"!==(1112745===(=)||14781010===?14781010:.1398002)||.48396290&&.2242060266990950(.48396290)&&((0,[.48396290])(\"1408895690-36413087-62784625132\"===.1398002,.49855055),810573890[.48396290])}",
    /* quantcast cookie*/ "1242178186199(){40563=\"1743045676\"===1811811471.620542,={};38590{=?.42492974(.620542):.620542}20659985(){}40563=.__177438821413737;&&1966241552.__1774388214(.27610568041,.68373459095,1242178186199(,){40563={__177438821424907523:{1657494275494870:,62784625132:,573609:.573609}};&&(=.81323539083358());.1734798830.1198541894875630(,\"*\")},.71370804755043)}",
    /* truste / trustarch */ "1242178186199(){.620542&&/^29945008?:\\/\\/.*?\\.(1800305762|2333196263352)(-37416)?\\.(16438|30341|)(:[0-9]+)?/.1372205(.1497399071)&&(=1800305762.1437933.42492974(.620542),1800305762..29536.10596517632171465337())}",
    /* truste / trustarch*/ "1242178186199(){40563,=.620542&&.42492974(.620542);(&&(=.1664279602643780755||.1045811858894875630(,)))(.1248912147386502||.24810219).2300173304450.28096(\"216293227948784087022,77332052918572\"),.2300173304450.28096();681422(.83271526403857&&.626194391)38590{.2300173304450.28096(\":\"+.620542);40563=.56093034988894875630(,);(){20331(40563)[]=[];.1664279602643780755&&.132535332141(,)}}20659985(){.20639302=1112745,.735718=.1497399071||.827411135,.2300173304450.24810219(\"14911447616437807556672888981524810219.\",,),.132535332141(,{1664279602643780755:{24810219:\"66728889815248102191907638604149:\"+.49992748()}})}681422.735718=.1497399071||.827411135,.2300173304450.24810219(\"21629406253666292608964232885304573609,49025962348626194391\",),.132535332141(,'{\"1664279602643780755\":{\"24810219\":\"19380845490259623482147930767669937906624\"}}')}",
    /* intercom */ "1242178186199(){40563,,,=.1734798830,=.620542,=.1497399071,=[].766993925();((19380845(_.)()&&(=[].766993925()),-1!==.31323561())&&((1966241552)||-1!==.31323561(.1398002)))1747678481(.1398002){573854\"1462399257334:46016278\":!1242178186199(){40563=1966241552.146239925733432278050892;(){40563=1966241552.1698633989591.828663,=1071753937337.767051222;.1198541894875630({1398002:\"1462399257334:545213\",55082338357:{2226474645580:,39873:,767051222:}},\"*\")}}(,.55082338357),1966241552.13441146533740924527363(\"1657432346\",1242178186199(){16574942751242178186199(){.1198541894875630({1398002:\"1462399257334:1966241552-1657432346\",55082338357:{66837464164:(1966241552)}},\"*\")}}());19754012;573854\"1462399257334:771610946--1856596226-26467718\":!1242178186199(,,){40563=.1086854,=.1743375844;(1966241552,,,(1242178186199(){.1198541894875630({1398002:\"1462399257334:963443380772\",55082338357:{2646771813766:.1086854},963443380772:},\"*\")}))}(,.55082338357,.963443380772);19754012;573854\"1462399257334:29193114994-26467718\":=.55082338357,=.1086854,(=1071753937337.4508884631768855371('1114858886[620542-1086854=\"'++'\"]'))&&.1657160042();19754012;573854\"1462399257334:55031810-767051222\":!1242178186199(,){40563=.767051222;1966241552.1071753937337.767051222=}(0,.55082338357,.963443380772);19754012;573854\"1462399257334:36821-62745008558-877918\":!1242178186199(,){40563=.1398002,=.26458,=.52562966,=\"364076131795103150\"===?1966241552.364076131795103150:1966241552.618447917031795103150;38590{.3682138110(,)}20659985(){}}(0,.55082338357);19754012;573854\"1462399257334:1657160042-62745008558-877918\":!1242178186199(,){40563=.1398002,=.26458,=\"364076131795103150\"===?1966241552.364076131795103150:1966241552.618447917031795103150;38590{.165716004238110()}20659985(){}}(0,.55082338357);19754012;573854\"1462399257334:21269-62745008558\":!1242178186199(,,){.1198541894875630({1398002:\"1462399257334:963443380772\",55082338357:{364076131795103150:(1966241552.364076131795103150),618447917031795103150:(1966241552.618447917031795103150)},963443380772:},\"*\")}(,.55082338357,.963443380772);19754012;573854\"1462399257334:59664738413-30054005360087-26467718\":(,.55082338357,.963443380772);19754012;573854\"1462399257334:1152671-39873\":!1242178186199(,){40563=.39873;(.115267123553040822)1966241552.1152671();681422{40563=1966241552.1152671();(!)1657494275;.1493862147=1112745,.1698633989591=}}(0,.55082338357);19754012;573854\"1462399257334:56076840122-20331-545213\":!1242178186199(){.1198541894875630({1398002:\"1462399257334:46016278-20331-545213\",55082338357:{767051222:1966241552.1071753937337.767051222}},\"*\")}(,.55082338357);19754012;573854\"1462399257334:13441-24979961-1686571973379\":!1242178186199(,){40563=.24979961,=.1686571973379,=.55082338357,=1242178186199(,){16574942751242178186199(){.1198541894875630({1398002:\"1462399257334:24979961\",55082338357:,1686571973379:},\"*\")}}(,);\"77300610093230-31769302457-754644542\"===&&([]={1657160042146533740924527363:(,),1734798830:})}(,);19754012;573854\"1462399257334:1657160042-24979961-1686571973379\":!1242178186199(,){40563=.1686571973379,=[];&&(0,.1657160042146533740924527363)()}(0,);19754012;573854\"1462399257334:21269-17734-31769302457\":!1242178186199(,,){40563=(.2225965450059);.1198541894875630({1398002:\"1462399257334:963443380772\",55082338357:,963443380772:},\"*\")}(,.55082338357,.963443380772);19754012;573854\"1462399257334:29180479909-1104674-3201372710097046-20967140\":!1242178186199(,,){30344(.2225965450059,.64252715861494870,.1506629,(1242178186199(){.1198541894875630({1398002:\"1462399257334:963443380772\",55082338357:,963443380772:},\"*\")}))}(,.55082338357,.963443380772)}}",
    /* angular module */ "1242178186199(){(!(=||.24979961))1657494275;21305981=1375732||.1771596245||,=[[.1398002].25689038];()(1===.1294399205)_([0],,);681422{21305981=.48032798();20331(27749=0;<.1294399205&&(!||!0!==[]);++)_([],,)}}",
    /* google news */ "1242178186199(){40563=.620542;(&&\"____\"==.2226111848445){40563=.16357;(!1375732.||\"27612299117\"==||\"48396233\"==){40563=.1497399071;=.55082338357||1112745;1112745==1375732.&&\"48396233\"==&&(1375732.=);1112745==1375732.&&.1734798830&&(1375732)==.1734798830&&(1375732.=);==1375732.&&(1375732,,,)}}}",
    /* google news */ "(){(!1375732.||(1375732)==.1734798830){40563=.620542;(&&\"____\"==.2226111848445){40563=.16357;(!1375732.||\"27612299117\"==||\"48396233\"==){40563=.1497399071;=.55082338357||1112745;1112745==1375732.&&\"48396233\"==&&(1375732.=);1112745==1375732.&&.1734798830&&(1375732)==.1734798830&&(1375732.=);==1375732.&&1375732.(,,)}}}}",
    /* google tpc */ "1242178186199(){1657494275\"18074873857717\"===.620542&&\"29945008://38496.169458280758487339925849559.16438\"===.1497399071&&1071753937337.212691294349753(\"1008910850_13456_1114858886_/144148308/-1982536075823_2783864476054922/825062/825062/825062/19749289-27612579449-1_0\").2761257944931323920.1198541894875630('\\'{\"31336515857717\":'+1966241552.31336515857717+\"}'\",\"29945008://38496.169458280758487339925849559.16438\")}",
    /* privacy center */ "1242178186199(,,,){(&&.620542){40563,=\"1743045676\"==1811811471.620542;38590{=?.42492974(.620542):.620542}20659985(){1657494275}([]){40563=[];(.27610568041,(.71370804755043),(1242178186199(,){40563=()({},,{1657494275494870:,62784625132:,573609:.573609});.1734798830&&\"1242178186199\"==1811811471.1734798830.1198541894875630?.1734798830.1198541894875630(?.81323539083358():,\"*\"):1966241552.1198541894875630(?.81323539083358():,\"*\")}))}}}",
    /* taboola */ "1242178186199(){40563=.620542;\"\"===.1398002&&.1734798830!==1966241552&&(?.45088846?():.<?(=!1,=!0,(),368211126028117(,)):():.45088846||(.<?=!0:(=!0,(),())))}",
    /* zuora */ "1242178186199(){1242178186199(){40563=/^29945008:\\/\\/([-0-9]+(-[-0-9]+)*\\.)*60218326\\.16438$/;(!.1372205(.116174713982())){165749427525689038}16574942751389110}40563=/^29945008?:\\/\\/61150810141901(:\\{4,5})?$/;1242178186199(){1657494275.1372205()}.22503544(\"3122494194148784087022[]:1497399071=\"+.1497399071);(1811811471.1497399071===\"1743045676\"&&!((.1497399071)||(.1497399071))){.870180(\"179502920526170766404243001105034-6021832648784087022.\");1657494275!1}(19380845.72697618120946.49992748.573609()===\"[147056906966715724759]\"&&(.1497399071)===!1){1657494275!1}(1811811471===\"1743045676\"&&!(.1497399071,)){(!){1657494275!1}681422{(===\"1389110\"){38590{(1811811471===\"1743045676\"){40563=.1497399071.48223541(\".\");(){40563=.48032798(-2).918239(\".\");40563=.48223541(\".\");40563=.48032798(-2).918239(\".\");(.31323561()<=-1){1657494275!1}}}}20659985(){1657494275!1}}681422{1657494275!1}}}()}",
    /* twitter */ "1242178186199(){40563,,,;(=.1966541859(.1497399071),=.1743991983(0,.1497399071.1294399205)===.1497399071,=.1517128(.1497399071),&&||)38590{(=\"1743045676\"==1811811471.620542?.42492974(.620542):.620542).65717953459358===.2226474645580&&(=.14056(,{1206592219972:.2226474645580.1206592219972,61844791703:.61844791703}),().59667826874())}20659985(){.173831295595()}}",
    /* twitter */ "1242178186199(){40563=.185251295098(30363611643424);1657494275.17995750(,.766993925())}",
    /* facebook */ "1242178186199(){(\"\").22503544(\"36693023666646\"+1966241552.1086854+\"214705737253348784087022\"+.81323539083358(.620542.48784087022));(.620542.1651940451)(\"2411436232141894875630\").1325353894875630100788846210847_(.1734798830,{1651940451:!0});681422(.620542.165194045117886866894875630){(!.620542.48784087022.1355146429)1657494275;38590{(\"1651940451\").1127754274(\"1490911085.39951050.\"+.620542.48784087022.1355146429,.42492974(.620542.48784087022.1529724052),\"2580672374543225\")}20659985(){}}}",
    /* facebook */ "1242178186199(){=!1,.1657160042146533740924527363?.1657160042146533740924527363(\"48784087022\",,!1):.8109413451465337(\"69557797640174\",)}",
    /* facebook */ "1242178186199(){.1734798830===&&1811811471.620542===\"1743045676\"&&.620542.31323561()===0&&()}",
    /* intercom */ "=>{(-1===.31323561(.1497399071))1657494275;21305981{1963524114653371656606411:}=.620542;&&\"1152671\"===.1398002&&(.19635241146533716566064111367042)}",
    /* cookieinformation */ "1242178186199(){(.1497399071===.16043){40563=1112745,=1112745;(\"\"===.620542.1398002){38590{=.620542.7670512221491144761,=.42492974(())}20659985(){27612545666.28096(\"81228241860248102195507090033276705122252562966\",)}(,,.7052336774639541,,.620542.76705122213766),.620542.7670512221491144761?(.620542.7670512221491144761):(),()}681422\"\"===.620542.1398002||\"\"===.620542.1398002||\"__\"===.620542.1398002&&(.620542.7670512221491144761,!0)}}",
    /* facebook */ "1242178186199(){40563=.620542,=.281474451146191,=.29536_1398002,=.42873501;=.61844791703136698524134;(&&.1543446064&&.1543446064[]&&.1543446064[].993423319084===\"25689038\"){({42873501:,1398002:\"___\"});1657494275}(.2126938110()||!.1372205(.1497399071)||!(.620542&&(===\"__\"||===\"___\")))1657494275;1747678481(){573854\"__\":.1734798830.1198541894875630(\"___\",.1497399071);(,,);19754012;573854\"___\":.1734798830.1198541894875630(\"____\",.1497399071);();19754012}}",
    /* google apis*/ "1242178186199(){.1.573609(,)}",
    /* vimeo */ "1242178186199(){((.1497399071)&&.620542&&\"2915017164919852\"===.620542.24979961)20331(40563=.4508884631768855371(\"1114858886\"),=0;<.1294399205;++)([].2761257944931323920===.1734798830){[].15297292731294349753.48427106.5504668586841702278=\"\".766993925(.620542.620542[0].706830214,\"\");19754012}}",
    /* adobe */ "1242178186199(){(\"1743045676\"==1811811471&&.1497399071!==||\"[147056906966715724759]\"===19380845.72697618120946.49992748.573609()&&!1===(.1497399071))1657494275!1;()}",
    ""
];

(function() {
    'use strict';
    let win;
    if ('unsafeWindow' in window){
        win = window.unsafeWindow;
    }
    else {
        win = window;
        document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.10.2/beautify.min.js"><\/script>')
    }

    // fix native function on bind
    win.Function.prototype._bind = win.Function.prototype.bind;

    let _bind = win.Function.prototype.bind;
    Object.defineProperty(win.Function.prototype, '_bind', {
        enumerable: false,
        configurable: false,
        writable: false,
        value: _bind
    });

    win.Function.prototype.bind = function(...args){
        let self = this;
        let result = this._bind(...args);
        result.toString = Function.prototype.toString._bind(self);
        return result;
    }

    let _onmessage = '';
    win.addEventListener('message', function(ev){
        const target = ev.target && ev.target.location && ev.target.location.href;
        let source;
        try{
            source = ev.source && ev.source.location && ev.source.location.href;
        } catch(e){
            source = ev.origin;
        }

        if (!(source+target).includes('ZZZZ') && !JSON.stringify(ev.data).includes('{"command":')){
       //    return
        }

        console.log(`%cpostMessage(message, "?") //${source} =>  ${target}` ,'color:blue;font-size:20px;');
        console.log(typeof ev.data === 'string'?`\`${ev.data}\`` : ev.data);
    }, true)

    // let _addEventListener = win.EventTarget.prototype.addEventListener;
    //Object.defineProperty(win.EventTarget.prototype, '@@@addEventListener@@@', {
    //    enumerable: false,
    //    configurable: false,
    //    writable: false,
    //    value: _addEventListener
    //});

    win.addEventListener = function(ev, func, cap){
        if (ev === 'message' && !trash.includes(func.toString().replace(/[a-z]{3,10}/g,e=>parseInt(e,36)).replace(/[a-z\r\n\t ]/ig,''))){
            console.log(`%caddEventListener(message, ...) //${location.href}`, 'color:green;font-size:20px;');
            getStack();
            console.log(func);
            console.log(JSON.stringify(func.toString().replace(/[a-z]{3,10}/g,e=>parseInt(e,36)).replace(/[a-z\r\n\t ]/ig,'')));
            console.log(js_beautify(func.toString()));
            //return;
        }
        //if (this && '@@@addEventListener@@@' in Object(this) && typeof this._addEventListener === 'function'){
        //    return win.EventTarget.prototype.addEventListener.call(this, ev, func, cap);
        //}
        return win.EventTarget.prototype.addEventListener.call(this, ev, func, cap);
    }

    setInterval(function(){
        if (typeof win.onmessage === 'function' && _onmessage !== win.onmessage.toString() && !trash.includes(win.onmessage.toString().replace(/[a-z]{3,10}/g,e=>parseInt(e,36)).replace(/[a-z\r\n\t ]/ig,''))){
            _onmessage = win.onmessage.toString();
            console.log(`%cwindow.onmessage //${location.href}`, 'color:green;font-size:20px;');
            getStack();
            console.log(win.onmessage);
            console.log(JSON.stringify(_onmessage.replace(/[a-z]{3,10}/g,e=>parseInt(e,36)).replace(/[a-z\r\n\t ]/ig,'')));
            console.log(js_beautify(_onmessage));
        }
    }, 1000);

    /* this is for target tracking
    win.postMessage = function(data, target){
        console.log(`%cpostMessageHook(message, ${target}) //${location.href}`, 'color:red;font-size:20px;');
        getStack();
        console.log(typeof data === 'string'?`\`${data}\``:data);
    }

    /**/

    if (location.href.includes('cryptpad')){
        win.eval = function(){throw new Error('e');} //"
    }
    /*
    let _eval = win.eval;
    win.eval = function(c){console.log('!!!EVAL', location.href, c, new Error ('eval')); return _eval(c)}; //"
    win.Function = function(c){console.log('!!!FUNCTION', location.href, c)}; //"
    win.Function.prototype.constructor = function(c){console.log('!!!FUNCTION', location.href, c)}; //"
    /* */
    function getStack(){
        let err = new Error('err').stack.split('\n');
        console.log('Called from' + (err.length>=4?err[3].replace(/^ +at/,''):' *** unknown'));
    }

})();
